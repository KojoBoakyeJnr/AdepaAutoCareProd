<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Service Entry - Adepa Auto Care</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="attendant-theme">
    <div class="dashboard-container attendant-container">
        <header class="dashboard-header">
            <div class="branding">
                <img src="images/logo.jpeg"  alt="Washing Bay Logo" class="logo">
            </div>
         
            <button id="themeToggle" class="theme-toggle">
                <span class="dark-icon">üåô</span>
                <span class="light-icon">‚òÄÔ∏è</span>
            </button>

            <button class="btn logout-btn" onclick="logout()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                    <path d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                </svg>
                Logout
            </button>
        </header>

        <div class="entry-form-container">
            <form id="entryForm" class="modern-form">
                <div class="form-grid">
                    <div class="form-section">
                        <h3 class="section-title">Vehicle Details</h3>
                        <div class="input-group">
                            <label>Car Model</label>
                            <input type="text" id="carModel" required>
                        </div>
                        <div class="input-group">
                            <label>Car Type/Make</label>
                            <input type="text" id="carType" list="carTypes" required onchange="updateServicePrices()">
                            <datalist id="carTypes">
                                <option value="SALON">
                                <option value="4 X 4">
                                <option value="Full-size SUVs">
                                <option value="SPRINTER BUSES">
                                <option value="COASTER BUSES">
                                <option value="LONG BUSES">
                                <option value="KIA TRUCK SMALL (ABBOSEY OKAI)">
                                <option value="KIA TRUCK MEDIUM (BONGO)">
                                <option value="KIA TRUCK (BONGO 3)">
                                <option value="KIA TRUCK (MIGHTY)">
                                <option value="KIA TRUCK BIG (RHINO)">
                                <option value="CARGO TRUCKS SMALL">
                                <option value="CARGO TRUCKS LARGE">
                                <option value="CARGO TRUCKS EXTRA LARGE">
                                <option value="FUEL TANKER SMALL">
                                <option value="FUEL TANKER LARGE">
                                <option value="TIPPER TRUCK 5 WHEELER">
                                <option value="TIPPER TRUCK 10 WHEELER">
                                <option value="TIPPER TRUCK 12 - 16 WHEELER">
                                <option value="MOTOR BIKE">
                            </datalist>
                        </div>
                        <div class="input-group">
                            <label>Car Number</label>
                            <input type="text" id="carNumber" required>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">Customer Details</h3>
                        <div class="input-group">
                            <label>Customer Name</label>
                            <input type="text" id="customerName" required>
                        </div>
                        <div class="input-group">
                            <label>Mobile Number</label>
                            <input type="tel" id="mobileNumber" pattern="[0-9]{10}" placeholder="Enter 10-digit mobile number" required>
                        </div>
                        <div class="input-group">
                            <label>Email (Optional)</label>
                            <input type="email" id="email" placeholder="Enter email address">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">Service Details</h3>
                        <div class="input-group">
                            <label>Primary Service</label>
                            <input type="text" id="serviceType1" list="primaryServices" required onchange="calculateTotalAmount()" placeholder="Select or type service">
                            <datalist id="primaryServices">
                                <option value="Body Wash">
                                <option value="Engine Wash">
                                <option value="Under Wash">
                                <option value="Interior">
                                <option value="Full Detailing (Interior & Exterior)">
                            </datalist>
                        </div>
                        <div class="input-group">
                            <label>Secondary Service</label>
                            <input type="text" id="serviceType2" list="secondaryServices" onchange="calculateTotalAmount()" placeholder="Optional">
                            <datalist id="secondaryServices">
                                <option value="Body Wash">
                                <option value="Engine Wash">
                                <option value="Under Wash">
                                <option value="Interior">
                                <option value="Full Detailing (Interior & Exterior)">
                            </datalist>
                        </div>
                        <div class="input-group">
                            <label>Washer Name</label>
                            <input type="text" id="washerName" required>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">Payment Details</h3>
                        <div class="input-group">
                            <label>Payment Type</label>
                            <select id="paymentType" required>
                                <option value="">Select payment type</option>
                                <option value="cash">Cash</option>
                                <option value="cheque">Cheque</option>
                                <option value="card">Card</option>
                                <option value="mobile_money">Mobile Money</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label>Total Amount (GHS)</label>
                            <input type="number" id="amount" readonly>
                        </div>
                        <div class="input-group">
                            <label>Washer Commission (GHS)</label>
                            <input type="number" id="washerCommission" oninput="calculateCompanyCommission()">
                        </div>
                        <div class="input-group">
                            <label>Company Commission (GHS)</label>
                            <input type="number" id="companyCommission" readonly>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="reset" class="btn clear-btn">Clear Form</button>
                    <button type="submit" class="btn submit-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-save" viewBox="0 0 16 16">
                            <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"/>
                        </svg>
                        Save Entry
                    </button>
                </div>
            </form>
        </div>

        <div class="loading-overlay" id="loading">
            <div class="loading-spinner"></div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmationModal" class="modal-overlay">
            <div class="modal-content">
                <h3>Final Confirmation</h3>
                <p>Once submitted, this entry cannot be edited. Are you sure you want to proceed?</p>
                <div class="modal-buttons">
                    <button class="modal-button cancel-btn" id="cancelSubmit">Go Back</button>
                    <button class="modal-button confirm-btn" id="confirmSubmit">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    <div id="passwordModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Change Password</h3>
            <div id="passwordError" class="error-message"></div>
            <div id="passwordSuccess" class="success-message"></div>
            <form id="passwordForm" class="password-form">
                <div class="input-group">
                    <label>Current Password</label>
                    <input type="password" id="currentPassword" required>
                </div>
                <div class="input-group">
                    <label>New Password</label>
                    <input type="password" id="newPassword" required>
                </div>
                <div class="input-group">
                    <label>Confirm New Password</label>
                    <input type="password" id="confirmPassword" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="modal-button cancel-btn" onclick="closePasswordModal()">Cancel</button>
                    <button type="submit" class="modal-button confirm-btn">Change Password</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
    const userRole = localStorage.getItem('userRole');
    
    if (!userRole) {
        window.location.href = 'login.html';
        return;
    }},)
        // Price mapping based on vehicle type and service
        const priceMap = {
            "SALON": {
                "Body Wash": 20,
                "Engine Wash": 20,
                "Under Wash": 20,
                "Interior": 80,
                "Full Detailing (Interior & Exterior)": 250
            },
            "4 X 4": {
                "Body Wash": 25,
                "Engine Wash": 25,
                "Under Wash": 25,
                "Interior": 100,
                "Full Detailing (Interior & Exterior)": 300
            },
            "Full-size SUVs": {
                "Body Wash": 30,
                "Engine Wash": 30,
                "Under Wash": 30,
                "Interior": 120,
                "Full Detailing (Interior & Exterior)": 350
            },
            "SPRINTER BUSES": {
                "Body Wash": 35,
                "Engine Wash": 35,
                "Under Wash": 35,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            },
            "COASTER BUSES": {
                "Body Wash": 60,
                "Engine Wash": 60,
                "Under Wash": 60,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            },
            "LONG BUSES": {
                "Body Wash": 100,
                "Engine Wash": 100,
                "Under Wash": 100,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            },
            "KIA TRUCK SMALL (ABBOSEY OKAI)": {
                "Body Wash": 20,
                "Engine Wash": 20,
                "Under Wash": 20,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            },
            "KIA TRUCK MEDIUM (BONGO)": {
                "Body Wash": 25,
                "Engine Wash": 25,
                "Under Wash": 25,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            },
            "KIA TRUCK (BONGO 3)": {
                "Body Wash": 30,
                "Engine Wash": 30,
                "Under Wash": 30,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            },
            "KIA TRUCK (MIGHTY)": {
                "Body Wash": 40,
                "Engine Wash": 40,
                "Under Wash": 40,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            },
            "KIA TRUCK BIG (RHINO)": {
                "Body Wash": 60,
                "Engine Wash": 60,
                "Under Wash": 60,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            },
            "CARGO TRUCKS SMALL": {
                "Body Wash": 100,
                "Engine Wash": 100,
                "Under Wash": 100,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            },
            "CARGO TRUCKS LARGE": {
                "Body Wash": 120,
                "Engine Wash": 120,
                "Under Wash": 120,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            },
            "CARGO TRUCKS EXTRA LARGE": {
                "Body Wash": 150,
                "Engine Wash": 150,
                "Under Wash": 150,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            },
            "FUEL TANKER SMALL": {
                "Body Wash": 150,
                "Engine Wash": 150,
                "Under Wash": 150,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            },
            "FUEL TANKER LARGE": {
                "Body Wash": 200,
                "Engine Wash": 200,
                "Under Wash": 200,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            },
            "TIPPER TRUCK 5 WHEELER": {
                "Body Wash": 120,
                "Engine Wash": 120,
                "Under Wash": 120,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            },
            "TIPPER TRUCK 10 WHEELER": {
                "Body Wash": 150,
                "Engine Wash": 150,
                "Under Wash": 150,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            },
            "TIPPER TRUCK 12 - 16 WHEELER": {
                "Body Wash": 200,
                "Engine Wash": 200,
                "Under Wash": 200,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            },
            "MOTOR BIKE": {
                "Body Wash": 10,
                "Engine Wash": 10,
                "Under Wash": 10,
                "Interior": 0,
                "Full Detailing (Interior & Exterior)": 0
            }
        };

        // List of valid options for validation
        const validCarTypes = [
            "SALON", "4 X 4", "Full-size SUVs", "SPRINTER BUSES", "COASTER BUSES", 
            "LONG BUSES", "KIA TRUCK SMALL (ABBOSEY OKAI)", "KIA TRUCK MEDIUM (BONGO)", 
            "KIA TRUCK (BONGO 3)", "KIA TRUCK (MIGHTY)", "KIA TRUCK BIG (RHINO)", 
            "CARGO TRUCKS SMALL", "CARGO TRUCKS LARGE", "CARGO TRUCKS EXTRA LARGE", 
            "FUEL TANKER SMALL", "FUEL TANKER LARGE", "TIPPER TRUCK 5 WHEELER", 
            "TIPPER TRUCK 10 WHEELER", "TIPPER TRUCK 12 - 16 WHEELER", "MOTOR BIKE"
        ];

        const validServices = [
            "Body Wash", "Engine Wash", "Under Wash", "Interior", 
            "Full Detailing (Interior & Exterior)"
        ];

        // Function to validate input against a list of valid options
        function validateInput(inputElement, validOptions, fieldName) {
            const value = inputElement.value.trim();
            if (value && !validOptions.includes(value)) {
                alert(`Please select a valid ${fieldName} from the list.`);
                inputElement.value = '';
                inputElement.focus();
                return false;
            }
            return true;
        }

        // Function to prevent duplicate services
        function validateServiceDuplicates() {
            const service1 = document.getElementById('serviceType1').value.trim();
            const service2 = document.getElementById('serviceType2').value.trim();
            
            if (service1 && service2 && service1 === service2) {
                alert('Primary and Secondary services cannot be the same.');
                document.getElementById('serviceType2').value = '';
                document.getElementById('serviceType2').focus();
                return false;
            }
            return true;
        }

        function calculateTotalAmount() {
            // Validate inputs first
            if (
                !validateInput(document.getElementById('carType'), validCarTypes, 'car type') ||
                !validateInput(document.getElementById('serviceType1'), validServices, 'primary service') ||
                (
                    document.getElementById('serviceType2').value.trim() &&
                    !validateInput(document.getElementById('serviceType2'), validServices, 'secondary service')
                ) ||
                !validateServiceDuplicates()
            ) {
                document.getElementById('amount').value = '';
                return;
            }

            const carType = document.getElementById('carType').value;
            const service1 = document.getElementById('serviceType1').value;
            const service2 = document.getElementById('serviceType2').value;
            const amountInput = document.getElementById('amount');
            
            if (!carType || !service1) {
                amountInput.value = '';
                return;
            }
            
            let total = 0;
            
            // Add primary service price
            if (service1 && priceMap[carType] && priceMap[carType][service1]) {
                total += priceMap[carType][service1];
            }
            
            // Add secondary service price if selected
            if (service2 && priceMap[carType] && priceMap[carType][service2]) {
                total += priceMap[carType][service2];
            }
            
            amountInput.value = total;
            calculateCompanyCommission();
        }

        function calculateCompanyCommission() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const washerCommission = parseFloat(document.getElementById('washerCommission').value) || 0;
            const companyCommission = amount - washerCommission;
            
            document.getElementById('companyCommission').value = companyCommission.toFixed(2);
        }

        function updateServicePrices() {
            calculateTotalAmount();
        }

        // Add event listeners for validation
        document.getElementById('carType').addEventListener('blur', function() {
            validateInput(this, validCarTypes, 'car type');
            updateServicePrices();
        });

        document.getElementById('serviceType1').addEventListener('blur', function() {
            validateInput(this, validServices, 'primary service');
            validateServiceDuplicates();
            calculateTotalAmount();
        });

        document.getElementById('serviceType2').addEventListener('blur', function() {
            if (this.value.trim()) {
                validateInput(this, validServices, 'secondary service');
            }
            validateServiceDuplicates();
            calculateTotalAmount();
        });

        // Form Submission Handling
        const form = document.getElementById('entryForm');
        const confirmationModal = document.getElementById('confirmationModal');
        const cancelSubmit = document.getElementById('cancelSubmit');
        const confirmSubmit = document.getElementById('confirmSubmit');

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Final validation before showing confirmation
            if (!validateInput(document.getElementById('carType'), validCarTypes, 'car type') ||
                !validateInput(document.getElementById('serviceType1'), validServices, 'primary service') ||
                (document.getElementById('serviceType2').value.trim() && 
                 !validateInput(document.getElementById('serviceType2'), validServices, 'secondary service'))) {
                return;
            }
            
            if (!validateServiceDuplicates()) {
                return;
            }
            
            confirmationModal.style.display = 'flex';
        });

        cancelSubmit.addEventListener('click', () => {
            confirmationModal.style.display = 'none';
        });

        confirmSubmit.addEventListener('click', async () => {
            confirmationModal.style.display = 'none';
            const loading = document.getElementById('loading');
            
            try {
                loading.style.display = 'flex';
                
                const data = {
                    customerName: document.getElementById('customerName').value,
                    carModel: document.getElementById('carModel').value,
                    carType: document.getElementById('carType').value,
                    carNumber: document.getElementById('carNumber').value,
                    mobileNumber: document.getElementById('mobileNumber').value,
                    email: document.getElementById('email').value,
                    serviceType1: document.getElementById('serviceType1').value,
                    serviceType2: document.getElementById('serviceType2').value,
                    washerName: document.getElementById('washerName').value,
                    paymentType: document.getElementById('paymentType').value,
                    amount: document.getElementById('amount').value,
                    washerCommission: document.getElementById('washerCommission').value,
                    companyCommission: document.getElementById('companyCommission').value
                };

                const response = await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showSuccessMessage();
                    const queryString = new URLSearchParams(data).toString();
                    window.location.href = `receipt.html?${queryString}`;
                    form.reset();
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorMessage();
            } finally {
                loading.style.display = 'none';
            }

        });

        function showSuccessMessage() {
            const msg = document.createElement('div');
            msg.className = 'success-message';
            msg.textContent = 'Entry saved successfully!';
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 3000);
        }

        function showErrorMessage() {
            const msg = document.createElement('div');
            msg.className = 'error-message';
            msg.textContent = 'Error saving entry. Please try again.';
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 3000);
        }

        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const storedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', storedTheme);

        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });

        function logout() {
            localStorage.removeItem('userRole');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        }
    
        // Password change modal functions
        function openPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('passwordSuccess').style.display = 'none';
            document.getElementById('passwordForm').reset();
        }
    
        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }
    
        // Initialize password form event listener
        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Get stored attendant password
            const storedPassword = localStorage.getItem('attendantPassword') || 'client.adepa';
            
            // Show error if current password is incorrect
            if (currentPassword !== storedPassword) {
                document.getElementById('passwordError').textContent = 'Current password is incorrect';
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordSuccess').style.display = 'none';
                return;
            }
            
            // Show error if new passwords don't match
            if (newPassword !== confirmPassword) {
                document.getElementById('passwordError').textContent = 'New passwords do not match';
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordSuccess').style.display = 'none';
                return;
            }
            
            // Update the password
            localStorage.setItem('attendantPassword', newPassword);
            
            // Show success message
            document.getElementById('passwordSuccess').textContent = 'Password changed successfully';
            document.getElementById('passwordSuccess').style.display = 'block';
            document.getElementById('passwordError').style.display = 'none';
            
            // Close modal after 2 seconds
            setTimeout(closePasswordModal, 2000);
        });

  document.getElementById('mobileNumber').addEventListener('input', function(e) {
        // Remove all non-digit characters (including spaces)
        let value = e.target.value.replace(/\D/g, '');
        // Update the input value
        e.target.value = value;
    });

    </script>
</body>
</html>